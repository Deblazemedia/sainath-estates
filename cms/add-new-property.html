<!doctype html>
<html lang="en" class="minimal-theme">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/assets/img/favicons/favicon-16x16.png" type="image/png" />
  <!--plugins-->
  <link href="assets/plugins/simplebar/css/simplebar.css" rel="stylesheet" />
  <link href="assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet" />
  <link href="assets/plugins/metismenu/css/metisMenu.min.css" rel="stylesheet" />
  <!-- Bootstrap CSS -->
  <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
  <link href="assets/css/bootstrap-extended.css" rel="stylesheet" />
  <link href="assets/css/style.css" rel="stylesheet" />
  <link href="assets/css/icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <!-- loader-->
  <link href="assets/css/pace.min.css" rel="stylesheet" />


  <!--Theme Styles-->
  <link href="assets/css/dark-theme.css" rel="stylesheet" />
  <link href="assets/css/light-theme.css" rel="stylesheet" />
  <link href="assets/css/semi-dark.css" rel="stylesheet" />
  <link href="assets/css/header-colors.css" rel="stylesheet" />

  <title>Sainath Estate - Real Estate Agent</title>

  <!-- Fonts Awesome CSS -->
  <link rel="stylesheet" type="text/css" href="/assets/vendors/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>

<body>


  <!--start wrapper-->
  <div class="wrapper">
    <!--start top header-->
    <header class="top-header">
      <nav class="navbar navbar-expand">
        <div class="mobile-toggle-icon d-xl-none">
          <i class="bi bi-list"></i>
        </div>
        <div class="search-toggle-icon d-xl-none ms-auto">
          <!-- <i class="bi bi-search"></i> -->
        </div>
        <form class="searchbar d-none d-xl-flex ms-auto">
          <!-- <div class="position-absolute top-50 translate-middle-y search-icon ms-3"><i class="bi bi-search"></i></div> -->
          <input class="form-control" type="text">
          <div class="position-absolute top-50 translate-middle-y d-block d-xl-none search-close-icon"><i
              class="bi bi-x-lg"></i></div>
        </form>
        <div class="top-navbar d-none d-xl-block">
          <ul class="navbar-nav align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="https://sainathestate.com/" target="_blank"><i
                  class="fa-solid fa-arrow-up-right-from-square"></i> &nbsp; View
                Website
              </a>
            </li>
          </ul>
        </div>
        <div class="top-navbar-right ms-3">
          <ul class="navbar-nav align-items-center">
            <li class="nav-item dropdown dropdown-large">
              <a class="nav-link dropdown-toggle dropdown-toggle-nocaret" href="#" data-bs-toggle="dropdown">
                <div class="user-setting d-flex align-items-center gap-1">
                  <img src="assets/images/avatars/avatar-1.png" class="user-img" alt="">
                  <div class="user-name d-none d-sm-block">Bunty</div>
                </div>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#">
                    <div class="d-flex align-items-center">
                      <img src="assets/images/avatars/avatar-1.png" alt="" class="rounded-circle" width="60"
                        height="60">
                      <div class="ms-3">
                        <h6 class="mb-0 dropdown-user-name">Bunty</h6>
                        <small class="mb-0 dropdown-user-designation text-secondary">Admin</small>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li>
                  <a class="dropdown-item" href="#" onclick="logout()">
                    <div class="d-flex align-items-center">
                      <div class="setting-icon"><i class="fa-solid fa-arrow-right-from-bracket"></i></div>
                      <div class="setting-text ms-3"><span>Logout</span></div>
                    </div>
                  </a>

                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
    </header>
    <!--end top header-->

    <!--start sidebar -->
    <aside class="sidebar-wrapper" data-simplebar="true">
      <div class="sidebar-header">
        <div>
          <img src="/assets/img/logo_2.png" class="logo-icon" alt="logo icon">
        </div>

        <div class="toggle-icon ms-auto"><i class="bi bi-chevron-double-left"></i>
        </div>
      </div>
      <!--navigation-->
      <ul class="metismenu" id="menu">
        <li>
          <a href="index.html">
            <div class="parent-icon"><i class="fa-solid fa-building"></i>
            </div>
            <div class="menu-title">Properties</div>
          </a>
        </li>
        <!-- <li>
          <a href="gallery.html">
            <div class="parent-icon"><i class="fa-solid fa-image"></i>
            </div>
            <div class="menu-title">Gallery Images</div>
          </a>
        </li> -->
        <li>
          <a href="#" onclick="logout()">
            <div class="parent-icon"><i class="fa-solid fa-arrow-right-from-bracket"></i></div>
            <div class="menu-title">Logout</div>
          </a>

        </li>
      </ul>
      <!--end navigation-->
    </aside>
    <!--end sidebar -->

    <!--start content-->
    <main class="page-content">
      <!--breadcrumb-->
      <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">

        <div class="ps-3">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 p-0">

              <li class="breadcrumb-item active" aria-current="page">Property Details</li>
            </ol>
          </nav>
        </div>

      </div>
      <!--end breadcrumb-->

      <div class="row">
        <div class="col-lg-8 mx-auto">
          <div class="card">
            <div class="card-header py-3 bg-transparent">
              <h5 class="mb-0">Add New Property</h5>
            </div>
            <div class="card-body">

              <form id="propertyForm" class="row g-3 border p-3 rounded" enctype="multipart/form-data">
                <!-- Title -->
                <div class="col-12">
                  <label class="form-label">Property title</label>
                  <input type="text" id="propertyTitle" class="form-control" placeholder="Property title">
                </div>

                <!-- Description -->
                <div class="col-12">
                  <label class="form-label">Full description</label>
                  <div id="descriptionEditor" style="height: 300px;"></div>
                  <input type="hidden" id="fullDescription">
                </div>

                <!-- Slider Image Upload -->
                <div class="col-12">
                  <div class="mb-2">
                    <img id="sliderPreview" src="#" alt="Slider Image" width="120" class="img-thumbnail"
                      style="display:none; cursor:pointer;" onclick="showImagePopup(this.src)">
                    <div id="sliderLoading" style="display:none; position:absolute; top:0; left:0; right:0; bottom:0;
               background: rgba(255,255,255,0.7); align-items:center; justify-content:center;">
                      <div class="spinner-border text-primary" role="status" style="width: 2rem; height: 2rem;">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  </div>
                  <label class="form-label">Slider Image (Image Must be in 416x488)</label>
                  <input class="form-control" type="file" id="sliderImageInput">
                </div>

                <!-- Banner Image Upload -->
                <div class="col-12">
                  <div class="mb-2">
                    <img id="bannerPreview" src="#" alt="Banner Image" width="120" class="img-thumbnail"
                      style="display:none; cursor:pointer;" onclick="showImagePopup(this.src)">
                    <div id="bannerLoading" style="display:none; position:absolute; top:0; left:0; right:0; bottom:0;
               background: rgba(255,255,255,0.7); align-items:center; justify-content:center;">
                      <div class="spinner-border text-primary" role="status" style="width: 2rem; height: 2rem;">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  </div>
                  <label class="form-label">Banner Image (Image Must be in 1296x555)</label>
                  <input class="form-control" type="file" id="bannerImageInput">
                </div>

                <!-- Location -->
                <div class="col-12">
                  <label class="form-label">Location</label>
                  <input type="text" id="propertyLocation" class="form-control" placeholder="Enter Location">
                </div>

                <!-- Status -->
                <div class="col-12 col-md-6">
                  <label class="form-label">Status</label>
                  <select id="propertyStatus" class="form-select">
                    <option value="available">Available</option>
                    <option value="sold">Sold</option>
                    <option value="pending">Pending</option>
                  </select>
                </div>

                <!-- Listing Type -->
                <div class="col-12 col-md-6">
                  <label class="form-label">Listing Type</label>
                  <select id="listingType" class="form-select">
                    <option value="buy">Buy</option>
                    <option value="rent">Rent</option>
                  </select>
                </div>

                <!-- Category -->
                <div class="col-12 col-md-6">
                  <label class="form-label">Category</label>
                  <select id="category" class="form-select">
                    <option value="luxury">Luxury</option>
                    <option value="commercial">Commercial</option>
                  </select>
                </div>

                <!-- Type -->
                <div class="col-12 col-md-6">
                  <label class="form-label">Type</label>
                  <input type="text" id="propertyType" class="form-control" placeholder="e.g. 1 BHK, 2 BHK, Plot">
                </div>

                <div class="col-12">
                  <label class="form-label">Upload Property Walkthrough Video</label>
                  <video id="videoPreview" width="320" height="180" controls
                    style="display: none; margin-bottom: 10px;"></video>
                  <button type="button" id="removeVideoBtn" class="btn btn-sm btn-outline-danger mb-2"
                    style="display: none;">Remove Video</button>
                  <input class="form-control" type="file" id="videoInput" name="propertyVideo" accept="video/*">
                </div>




                <!-- Price -->
                <div class="col-12">
                  <label class="form-label">Price</label>
                  <input type="text" id="propertyPrice" class="form-control" placeholder="Price">
                </div>

                <!-- Action Row -->
                <div id="actionRow" class="col-12 row g-3">
                  <!-- Buttons will be inserted by JS -->
                </div>
              </form>


            </div>
          </div>
        </div><!--end row-->

    </main>
    <!--end page main-->


    <!--start overlay-->
    <div class="overlay nav-toggle-icon"></div>
    <!--end overlay-->

    <!--Start Back To Top Button-->
    <a href="javaScript:;" class="back-to-top"><i class='bx bxs-up-arrow-alt'></i></a>
    <!--End Back To Top Button-->

    <!--start switcher-->

    <!--end switcher-->

  </div>
  <!--end wrapper-->


  <!-- Bootstrap bundle JS -->
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <!--plugins-->
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/plugins/simplebar/js/simplebar.min.js"></script>
  <script src="assets/plugins/metismenu/js/metisMenu.min.js"></script>
  <script src="assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js"></script>
  <script src="assets/js/pace.min.js"></script>
  <!--app-->
  <script src="assets/js/app.js"></script>
  <script>
    const BASE_URL = 'https://sainath-estate-backend-production.up.railway.app';
    let quill;

    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const propertyId = params.get('id');
      const token = localStorage.getItem('token');
      const actionRow = document.getElementById('actionRow');

      // 🔧 Initialize Quill
      quill = new Quill('#descriptionEditor', {
        theme: 'snow',
        placeholder: 'Enter full property description...',
        modules: {
          toolbar: [
            [{ header: [1, 2, false] }],
            ['bold', 'italic', 'underline'],
            ['link', 'blockquote', 'code-block'],
            [{ list: 'ordered' }, { list: 'bullet' }],
            ['clean']
          ]
        }
      });

      // 🔘 Image Upload Handlers
      function previewImageWithLoader(inputId, previewId, loaderId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const loader = document.getElementById(loaderId);

        input.addEventListener('change', () => {
          if (input.files && input.files[0]) {
            loader.style.display = 'flex';
            preview.style.display = 'none';

            const reader = new FileReader();
            reader.onload = function (e) {
              setTimeout(() => {
                preview.src = e.target.result;
                preview.style.display = 'block';
                loader.style.display = 'none';
              }, 1000);
            };
            reader.readAsDataURL(input.files[0]);
          }
        });
      }

      previewImageWithLoader('sliderImageInput', 'sliderPreview', 'sliderLoading');
      previewImageWithLoader('bannerImageInput', 'bannerPreview', 'bannerLoading');

      // 🟡 Load property data (for update)
      if (propertyId && token) {
        try {
          const res = await fetch(`${BASE_URL}/api/properties/${propertyId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          const property = await res.json();
          if (!res.ok) throw new Error('Failed to load property');

          document.getElementById('propertyTitle').value = property.title || '';
          quill.root.innerHTML = property.description || '';
          document.getElementById('propertyLocation').value = property.location || '';
          document.getElementById('listingType').value = property.listingType || 'buy';
          document.getElementById('category').value = property.category || 'luxury';
          document.getElementById('propertyType').value = property.type || '';
          document.getElementById('propertyStatus').value = property.status || 'available';
          document.getElementById('propertyPrice').value = property.price || '';

          if (property.slider_image) {
            const sliderImg = document.getElementById('sliderPreview');
            sliderImg.src = `${BASE_URL}/uploads/${property.slider_image}`;
            sliderImg.style.display = 'block';
          }

          if (Array.isArray(property.propertyBanner) && property.propertyBanner.length > 0) {
            const bannerImg = document.getElementById('bannerPreview');
            bannerImg.src = `${BASE_URL}/uploads/${property.propertyBanner[0]}`;
            bannerImg.style.display = 'block';
          }

          // ✅ Show existing video if available
          if (property.videos) {
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.src = property.videos;
            videoPreview.style.display = 'block';
          }

        } catch (err) {
          console.error('Error loading property:', err);
        }
      }


      // 🔘 Action Buttons (Add / Update / Delete)
      if (actionRow) {
        if (propertyId) {
          actionRow.innerHTML = `
          <div class="col-6">
            <button type="submit" class="btn btn-primary px-4" id="updateBtn">Update Property</button>
          </div>
          <div class="col-6 text-end">
            <button type="button" class="btn btn-danger px-4" onclick="confirmDelete('${propertyId}')">Delete</button>
          </div>`;
        } else {
          actionRow.innerHTML = `
          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="flexCheckDefault">
              <label class="form-check-label" for="flexCheckDefault">Publish on website</label>
            </div>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary px-4">Submit Item</button>
          </div>`;
        }
      }

      // 📨 Submit Handler (Add or Update)
      const form = document.getElementById('propertyForm') || document.querySelector('form');
      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        const isEdit = Boolean(propertyId);
        const updateBtn = document.getElementById('updateBtn');
        const isPublished = document.getElementById('flexCheckDefault')?.checked;

        if (updateBtn) {
          updateBtn.disabled = true;
          updateBtn.textContent = 'Updating...';
          updateBtn.classList.remove('btn-success', 'btn-danger');
          updateBtn.classList.add('btn-primary');
        }

        const formData = new FormData();
        formData.append('title', document.getElementById('propertyTitle').value);
        formData.append('description', quill.root.innerHTML);
        formData.append('location', document.getElementById('propertyLocation').value);
        formData.append('listingType', document.getElementById('listingType').value);
        formData.append('category', document.getElementById('category').value);
        formData.append('type', document.getElementById('propertyType').value);
        formData.append('price', document.getElementById('propertyPrice').value);
        formData.append('status', isEdit ? document.getElementById('propertyStatus').value : (isPublished ? 'available' : 'draft'));

        const sliderImageInput = document.getElementById('sliderImageInput');
        if (sliderImageInput.files[0]) {
          formData.append('slider_image', sliderImageInput.files[0]);
        }

        const bannerImageInput = document.getElementById('bannerImageInput');
        if (bannerImageInput.files[0]) {
          formData.append('propertyBanner', bannerImageInput.files[0]);
        }

        try {
          const method = isEdit ? 'PUT' : 'POST';
          const endpoint = isEdit
            ? `${BASE_URL}/api/properties/${propertyId}`
            : `${BASE_URL}/api/properties/add`;

          const res = await fetch(endpoint, {
            method,
            headers: {
              Authorization: `Bearer ${token}`
            },
            body: formData
          });

          const result = await res.json();
          if (!res.ok) throw new Error(result.error || 'Failed to save property');

          if (isEdit && updateBtn) {
            updateBtn.textContent = 'Updated';
            updateBtn.classList.remove('btn-primary');
            updateBtn.classList.add('btn-success');

            setTimeout(() => {
              updateBtn.textContent = 'Update Property';
              updateBtn.classList.remove('btn-success');
              updateBtn.classList.add('btn-primary');
            }, 2000);
          }
        } catch (err) {
          console.error('Save error:', err);
          if (updateBtn) {
            updateBtn.textContent = 'Update Failed';
            updateBtn.classList.remove('btn-primary');
            updateBtn.classList.add('btn-danger');
          }
        } finally {
          if (updateBtn) updateBtn.disabled = false;
        }
      });
    });

    function confirmDelete(id) {
      if (confirm('Are you sure you want to delete this property?')) {
        fetch(`${BASE_URL}/api/properties/${id}`, {
          method: 'DELETE',
          headers: {
            Authorization: `Bearer ${localStorage.getItem('token')}`
          }
        })
          .then(res => res.json())
          .then(() => {
            window.location.href = '/cms/index.html';
          })
          .catch(err => {
            console.error('Delete error:', err);
            alert('Failed to delete property');
          });
      }
    }

    function showImagePopup(url) {
      const popup = document.createElement('div');
      popup.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7); display: flex;
      justify-content: center; align-items: center;
      z-index: 9999; opacity: 0; transition: opacity 0.3s ease;
    `;

      const img = document.createElement('img');
      img.src = url;
      img.style.cssText = `
      max-width: 90%; max-height: 90%;
      border-radius: 8px; box-shadow: 0 0 20px #000;
      transform: scale(0.95); transition: transform 0.3s ease;
    `;

      popup.appendChild(img);
      document.body.appendChild(popup);
      void popup.offsetWidth;
      popup.style.opacity = '1';
      img.style.transform = 'scale(1)';

      popup.addEventListener('click', () => {
        popup.style.opacity = '0';
        img.style.transform = 'scale(0.95)';
        setTimeout(() => popup.remove(), 300);
      });
    }
  </script>

  <script>
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/cms/admin-signin.html';
    }
  </script>

  <script>
    // Protect dashboard pages from unauthorized access
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');

      if (!token) {
        window.location.href = '/cms/admin-signin.html';
        return;
      }

      // Prevent going back after logout
      window.history.pushState(null, null, window.location.href);
      window.onpopstate = function () {
        window.history.go(1);
      };
    });
  </script>
  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB1x6xFqKgah_fg31GzWaW70vip1pX4XN4",
      authDomain: "sainath-estate.firebaseapp.com",
      projectId: "sainath-estate",
      storageBucket: "sainath-estate.appspot.com",
      messagingSenderId: "454705170976",
      appId: "1:454705170976:web:284332ba0cb8ef53940a45",
      measurementId: "G-SYCBK76N5W"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    async function uploadVideo(file) {
      return new Promise((resolve, reject) => {
        const fileName = `videos/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, fileName);
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on(
          'state_changed',
          null,
          reject,
          () => {
            getDownloadURL(uploadTask.snapshot.ref).then(resolve).catch(reject);
          }
        );
      });
    }

    document.getElementById('propertyForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const token = localStorage.getItem('token');
      const videoFile = document.getElementById('videoInput').files[0];
      let videoUrl = null;

      // Only upload if a new video is selected
      if (videoFile) {
        videoUrl = await uploadVideo(videoFile);
        formData.append('videos', videoUrl); // ✅ update if changed
      }


      const formData = new FormData();
      formData.append('title', document.getElementById('propertyTitle').value);
      formData.append('description', quill.root.innerHTML);
      formData.append('price', document.getElementById('propertyPrice').value);
      formData.append('location', document.getElementById('propertyLocation').value);
      formData.append('type', document.getElementById('propertyType').value);
      formData.append('status', document.getElementById('propertyStatus').value);
      formData.append('listingType', document.getElementById('listingType').value);
      formData.append('category', document.getElementById('category').value);
      formData.append('videos', videoUrl); // ✅ Add Firebase video URL

      // Images if needed
      const sliderImage = document.getElementById('sliderImageInput');
      if (sliderImage.files[0]) {
        formData.append('slider_image', sliderImage.files[0]);
      }

      const bannerImage = document.getElementById('bannerImageInput');
      if (bannerImage.files[0]) {
        formData.append('propertyBanner', bannerImage.files[0]);
      }

      try {
        const res = await fetch('https://sainath-estate-backend-production.up.railway.app/api/properties/add', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${token}`
          },
          body: formData
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Failed to save');

        alert('Property added successfully!');
      } catch (err) {
        console.error('Upload error:', err);
        alert('Something went wrong.');
      }
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const removeVideoBtn = document.getElementById('removeVideoBtn');
      const videoPreview = document.getElementById('videoPreview');
      const videoInput = document.getElementById('videoInput');

      if (removeVideoBtn) {
        removeVideoBtn.addEventListener('click', () => {
          videoPreview.src = '';
          videoPreview.style.display = 'none';
          videoInput.value = '';
          removeVideoBtn.style.display = 'none';
        });
      }

      // Show preview on selecting a new video
      if (videoInput) {
        videoInput.addEventListener('change', () => {
          const file = videoInput.files[0];
          if (file) {
            videoPreview.src = URL.createObjectURL(file);
            videoPreview.style.display = 'block';
            removeVideoBtn.style.display = 'inline-block';
          }
        });
      }
    });
  </script>



</body>

</html>